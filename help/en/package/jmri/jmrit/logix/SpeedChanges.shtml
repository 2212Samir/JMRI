<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
  <meta name="generator" content=
  "HTML Tidy for Mac OS X (vers 31 October 2006 - Apple Inc. build 15.17), see www.w3.org">

  <title>JMRI: Warrant Table Help</title>
  <meta content="Pete Cressman" name="author">
  <meta name="keywords" content="JMRI help Modifying Warrant Speeds">
  <!-- Style -->
  <meta http-equiv="content-type" content=
  "text/html; charset=us-ascii">
  <link rel="stylesheet" type="text/css" href="/css/default.css"
  media="screen">
  <link rel="stylesheet" type="text/css" href="/css/print.css"
  media="print">
  <link rel="icon" href="/images/jmri.ico" type="image/png">
  <link rel="home" title="Home" href="/"><!-- /style -->
</head>

<body>
  <!--#include virtual="/Header" -->

  <div class="nomenu" id="mBody">
    <div id="mainContent">
      <h1>Modifying Warrant Speeds</h1>

      <p>Regardless of the throttle setting and intended track
      speed in the command script of a warrant, track conditions
      may occur that require a restriction of the track speed.
      "Stop" aspects of signals, occupancy or allocation to another
      warrant will deny permission to proceed. Other aspects of
      signals or block limits may require a reduction of speed.
      For an overview discussion of warrants, see <a href=
      "Warrant.shtml">Warrants</a>.</p>

      <h2>Warrants and Speed Restrictions</h2>A train running under
      a warrant must be aware of track conditions ahead. Signals
      may indicate reduced speed or permission to return to normal
      speed. Blocks may impose yard limit speed restrictions. Rogue
      trains may show up unexpectedly in the route. In our
      imagination, we can presume
      their detection means our warrant "engineer" sees a fusse. For
      each of these cases the warrant must look ahead, detect the
      need for a speed change and schedule the right time to do it
      - all the while making the change smoothly and completing it
      in prototypical fashion.
      
      <h3>Configuring Speed Restrictions</h3>
      For a warrant to detect a <b>signaled speed change</b> the signal 
      must be configured in the Occupancy Block Tables. 
      The Signal Table there configures the entrance Portal to the
      OBlock that the signal protects.  The warrant then uses the 
      signal system configured for the signal to detect the aspect
      speed.
      <p>Likewise, <b>block speeds</b> are configured in the Occupancy 
      Block Tables.  A column in the OBlock Table allows you to
      choose an aspect speed that the warrant will enforce
      before entering the block.</p>
      
      <p>When an <b>occupancy</b> sensor is activated ahead of the train
      on its route, the warrant will take note of it and
      bring the train to a stop before entering the block.</p>
      <p>Finally, <b>you</b> can manually instruct the warrant to ramp down to a stop
      or issue an emergency stop.  Also, you can ramp up from a stop 
      and resume the train's former speed.</p>
      
	  <p>When a warrant ramps down a speed change due to a signal, block
      or rouge occupancy condition, That speed change remains in
      effect until the condition is removed. At that time the
      speed is ramped up to the previous "normal" speed.  The
      precedence order is: rouge occupancy, signal aspect, block speed.</p>
            
      <h2>How Signals Aspects and Block Speeds Modify A Train's
      Speed</h2>When a warrant is running and its train enters a
      block, it looks ahead to see if any speed changes are coming
      up. The look ahead distance must be adequate for the train to
      be able to stop should that be needed. The warrant calculates
      the look ahead distance to be what is needed to stop from its 
      present speed. This distance may include several blocks. 
      If a signal or block is
      encountered within this look ahead distance, and the aspect
      protecting the block indicates the speed must be regulated, then
      the warrant will take action. It needs to inform the engine
      of the speed changes in a smooth (and hopefully prototypical)
      fashion and calculate when these speed changes should begin.

      <p>The distances calculated for speed changes use track speed
      information from the speed profile of the engine/consist
      powering the train. Lacking a speed profile, the <b>Throttle
      Setting/Speed Factor</b> is used to estimate track speed from
      the throttle setting. From the estimated track speeds a
      stepwise ramp is calculated for the speed change. The
      speed step parameters, <b>Ramp Step Time</b> and
      <b>Ramp Step Throttle Increment</b> are configured
      in Warrant Preferences.</p>

      <p>Once a speed change is noted by reading a signal aspect or
      specified block speed ahead, the Warrant must calculate when
      to begin the speed change (ramp down or ramp up). Both the
      look ahead distance and the time when to begin the speed
      change require knowing the track speed. Thus to get the
      train to begin and end its speed changes at the proper points,
      relating the throttle settings to the actual track
      speed is needed. Without such information a fast running
      engine may overrun the point where a speed change expects to
      be completed, or a slow running train may stop too far short
      of where it is expected.</p>

      <p>The throttle factors obviously depend upon the particular
      engine's power curve. This is a combination of decoder's
      throttle speed curve and the response of the locomotive motor
      to the voltage set by the speed curve. It is nearly
      impossible to set a single throttle factor that will work
      over the engine's entire speed range in both forward and
      reverse directions. A complete Speed Profile for every speed
      step of a decoder can be made with the Roster speed Profiling
      tool. Since Release 4.9.2 track speed information for Speed 
      Profiles are measured while running warrants.</p>

      <h3>A Note About Ramps</h3>When JMRI needs to intervene and
      enforce a speed change that was not recorded, several calculations
      must be made. Two pieces of information are vital.
      <ul>
        <li><b>Distance</b> from the train to the situation requiring  
        the speed change.  For this the lengths of the paths of the 
        route must be known. </li>
        <li><b>Speed</b> of the train.  For this a 
        correlation of the throttle settings to the actual speed
        of the train on the layout must be known.</li> 
      </ul>
      There are several options in providing this information and there
      are default values for all of the parameters.  You may want
      to experiment with warrants using these default settings
      and defer reading the following sections until later.

      <a name="RampParams" id="RampParams"></a>
      <h2>Parameters Needed for Ramping</h2>
      To compute how far to look ahead and the time when to modify
      speed require several parameters. <br>The following
      must be known.
      <ul>
        <li>
          <b>Block Lengths</b> are needed for distances.  There
          is a length column in the OBlock Table.  There is also
          a column to open its path tables. Each Path Table has
          a length column as well.  Likewise the Add/Edit OBlock 
          and Add/Edit OPaths
          menus in Circuit Builder have text fields to enter 
          lengths. Inches or centimeters may be used.
          <p>When no block length is specified error messages
          are written to the console and you may have trains 
          over-running their stopping points.  It is 
          <b><i>highly recommended</i></b>
          that path lengths be specified. <i>Your
          wild guess is better than the default.</i>  If the 
          paths within a block vary widely, path lengths
          should be set. Otherwise, path
          lengths are inherited from the block length.
        </li>
        <li><b>Layout Scale</b> is needed for distances when speed is
        expressed as Mph or Kmph.  This is set from a drop down box at
        the <b>Edit-&gt;Preferences-&gt;Warrants</b> menu of the main 
        PanelPro window</li>
        <li>
          <b>Track Speed</b> is more difficult to obtain reproducibly.
          <ul>
            <li>
            A first approximation is the <b>"Throttle Setting/Speed Factor"</b>
            value at Edit-&gt;Preferences-&gt;Warrants.
            <p>When used, this factor is a linear multiplier to relate throttle
            setting to track speed.  Note this is a global value for 
            all of the locomotives in your fleet and over the entire speed
            range of each.  Obviously this may not operate optimally.
            However, it could be satisfactory for your tastes.</li>
            <li> 
            For more precision a <b>Speed Profile</b> can be made for each
            locomotive.  While somewhat laborious to do, it does provide
            values to make more accurate calculations. The Speed Profiler
            is found at <b>Roster-&gt;Speed Profiling</b>.</li>  
          </ul>
          In spite of precise calculations, there are parameters
          such as train length, the friction of individual cars, track
          cleanliness, motor performance (and on and on) that influence
          actual track speed.
          <p>Release 4.9.2 attempts to compensate for such changes by
          measuring track speed dynamically when running a warrant.
          A "Session Speed Profile" is recorded during a layout session
          and at the end of the session may be merged into the Roster
          Speed Profile. 
         </li>
      </ul>  
	        
      The smoothness for slow down and
      speed up are done by stepping up and down with two "ramp"
      parameters; the throttle increment per step and the time
        interval of each step.  These two parameters are paired to
        make a "stair step" pattern for changing speed.  
        Generally, they are paired in that a small throttle increment
        should be done in a short time interval and a large increment
        in a longer time. When setting them, the time interval should
        be long enough for the speed increment to complete given the 
        momentum you have programmed into your decoders.
        They are set in <b>&gt;Edit-&gt;Preferences-&gt;Warrants</b>.
	  <ul>
        <li><b>Ramp Step throttle Increment</b>  This value is
        a ratio of full throttle. Seven or eight speed steps of a
        128 step throttle is an appropriate increment for a
        locomotive with modest momentum. A value of 0.008 to 0.04 is
        recommended. (0.008 would be 1 step of a 128 step throttle)</li>

        <li><b>Ramp Step time</b> Depending how you have
        configured momentum on your
        locomotives, adjust this value so the speed change is 
        completed within this period of time. Typically
        corresponding to the above, 
        300 to 1000 milliseconds would be appropriate.</li>
      </ul>
       You should experiment by watching how NXWarrants start and end
       or by issuing "Stop" and "Resume" commands to a recorded
       warrant.

      <h3>Getting Speed Profiles for Your Trains</h3>Converting a
      throttle setting to achieve a given track speed is dependent
      on the engine and its decoder. The decoder's speed
      curve to deliver voltage to the motor, and the motor's rpm
      response under load with that voltage is rarely linear. 
      Likewise, whether the
      motor is driving the train forward or reverse often results
      in different track speeds.

      <p>A Speed Profile can be made for an engine that will
      provide the necessary factors to set throttle settings that
      will result in more accurate track speeds. These profiles are
      maintained in the Roster and there is a tool that will create
      them at <b>Roster-&gt;Speed Profiling</b>
      </p>

      <a name="autoSpeedProfile" id="autoSpeedProfile"></a>
      <h4>Automatic Speed Profiling</h4>Since Release 4.9.2
      track speed of an engine/consist is measured when that address
      is used for running a warrant.  The data is kept for the layout
      session and when the session ends this Session Speed Profile 
      can be merged into the Roster Speed Profile.  Warrant Preferences
      provides choices for how you may want to manage the merging of
      Roster Speed Profiles.

      <h2>Aspect Speed Map and its Interpretation</h2>Speeds are
      named in the aspects.xml files that signal masts use in the
      Signal Mast System. These speed names are also used in the
      Blocks tables. To control train speed, values must be
      assigned to these speed names. The Aspect Speed Map found at
      <i>&gt;Edit-&gt;Preferences-&gt;Warrants</i> provides a value
      for each named speed. It is up to the user to assign a value
      to the name and a meaning to the value. On the preferences
      warrant panel there are four radio buttons to assign meaning
      to the values entered into the Speed Map Table.

      <p>In defining the four choices, to help explain them we'll
      use a few examples and compare them as the warrants approach
      a signal whose entrance speed name is "Medium". In the
      examples, the throttle setting for "Normal" is the recorded
      throttle setting when approaching the signal.<br>
      <b>Warrant#1</b> is recorded with Engine A and it achieves a
      scale speed of 60 mph (or 96 kmph) at a throttle setting of
      0.8 (102 speed steps). This was the "Normal" speed recorded
      by the warrant approaching the signal.<br>
      We will also assume engines B and C use Warrant#1. Engine B
      only reaches a scale speed 50 mph at an 0.8 throttle setting
      and Engine C attains a scale speed 70 mph at an 0.8 throttle
      setting is also used in the warrant.<br>
      <b>Warrant#2</b> is recorded with engine C and the "Normal"
      throttle setting approaching the signal was 0.68 which would
      be about 60 mph.<br>
      <b>Warrant#3</b> is a slow freight recorded with engine C and
      the "Normal" throttle setting approaching the signal was
      0.36, which would be about 31.5 mph.</p>

      <p>We have the situation where the warrants are looking ahead
      to a signal showing an aspect of "Medium" speed. The
      prototype railroad using this signal defines medium speed as
      30 mph. We will also assume we have set the Aspect speed name
      value to be the best guess we can make to duplicate
      prototypical speed at layout scale.</p>

      <ul>
        <li>
          <b>Percent of Normal</b> - The value is a percentage of
          the recorded ("Normal") speed. Speed names are
          restrictive, therefore this value should be less than
          100.

          <p>Best guess for the table value of "Medium" is 50.<br>
          Warrant#1 will reduce the setting to 0.40 and this could
          be a perfect scale 30 mph for Engine A and Engine B is
          likely to reduce speed to 25 mph, but engine C will
          likely pass the signal at 35 mph.<br>
          Warrant#2 will reduce the setting to 0.34 and this could
          be a perfect scale 30 mph for Engine C. Engine A is
          likely to pass the signal at 25.5 mph and Engine B at
          about 21 mph.<br>
          Warrant#3 will reduce the setting to 0.18 and this is
          likely to give Engine C a speed of 16 mph passing the
          signal. The speeds of Engines A and B will be even
          slower.<br>
          In all case the recorded speed is reduced by half. That
          is, <i>speed is always changed</i></p>
        </li>

        <li>
          <b>Percent of Full Throttle</b> - The value is an
          absolute throttle setting expressed as a percentage of
          full throttle, i.e. a number between 0 and 100.

          <p>A best guess for the table value for "Medium" is
          40.<br>
          Warrant#1 will make the setting 0.40 and so Engine A most
          likely will pass the signal at 30 mph. Engine B is likely
          to reduce speed to 25 mph, but engine C will likely pass
          the signal at 35 mph.<br>
          Warrant#2 will make the setting 0.40 and so Engines A, B
          and C will pass the signal at the same speeds as
          above.<br>
          Warrant#3 will not change the setting since it is already
          less than 0.40 so Engine C's speed will be unchanged at
          31.5 mph. Engine A most likely will pass the signal at 27
          mph and Engine B at 22.5 mph.<br>
          This interpretation <i>puts an upper limit on the
          throttle setting</i>, but not the scale speed.</p>
        </li>

        <li>
          <b>Miles per hour</b> - The value is the scale miles per
          hour.<br>
          The table value for "Medium" should be 30.

          <p>For Warrant#1 and Warrant#2, using each engine's
          throttle factor Engines A. B, and C all will likely pass
          the signal at 30 mph.<br>
          Warrant#3 will modify Engine C's speed to 30 mph. It will
          not modify the speeds of Engines A and B. Engine A most
          likely will pass the signal at 27 mph and Engine B at
          22.5 mph.<br>
          Given that a sufficient Speed Profile has been made,
          <i>Prototypical signal speeds can be done without speed
          matching.</i></p>
        </li>

        <li>
          <b>Kilometers per Hour</b> - The value is the scale
          kilometers per hour.<br>
          The table value for "Medium" should be 48.

          <p>The results are the same as the Mph case. This is
          simply using the metric system units.</p>
        </li>
      </ul>To sum up; if you are not fussy about being prototypical
      and always want to see speed change when signals are passed,
      use "Percent of Normal". If you have calibrated a sufficient
      Speed Profile for each of your engines you can use either of
      the last two speed interpretations which express throttle
      setting in terms of scale speed.

      <h3>The Signal Head Appearance Table</h3>If signal heads are
      used on the layout, their appearances can be mapped to the
      speed names of signal masts in this table on the warrant
      preferences panel.

      <p>One use of this is to use virtual signal heads to
      dynamically influence the behavior of warrants. The
      appearance of these signals can be set either by panel icons
      or Logix. Since there are 8 possible signal head appearances
      additional speed names can be created so a unique speed can
      be made for each appearance.</p>

      <h3>Editing the Speed Map Table</h3>Rows can be added or
      deleted. The default speed map has the names "Fifty" and
      "Sixty". These names only appear in signal mast systems for
      UP-2008 and BNSF-1996, so they can safely be deleted if you
      do use these signal systems. You only need but <i>must
      have</i> all the speed names that appear in the signal system
      you have configured for your layout.

      <p>If you add a new speed name for a signal head appearance,
      then add a row for that name in the Signal Map Table.</p>

      <h2>Block speed Names</h2>A speed name can be set for each
      block by selecting a name from the <b>Speed Notch</b> column
      of the OBlock Table. One use of this feature could be to
      enforce a yard limit speed. Unlike signal speed names, block
      speed names are bi-directional. To return a warrant's speed
      to normal when leaving a yard limit, the speed names of the
      OBlocks on either side of the yard block should set to
      "Normal". Use care when combining this feature with signals
      to avoid providing conflicting speed change messages.

      <p>To unset an OBlock speed name choose the blank setting
      from the <b>Speed Limit</b> column. As with the absence of a
      signal, when there is no speed name the warrant continues at
      its current speed.</p>
      
      <p><!--#include virtual="/Footer" --></p>
    </div><!-- closes #mainContent-->
  </div><!-- closes #mBody-->
</body>
</html>
